# 2. Transition to Poly-Hierarchy Tagging

**Date:** 2025-12-16
**Commit:** a1768a4

## 1. Overview
We have refactored the `TagOrchestratorService` to support **Poly-Hierarchy**, moving away from a strict Tree model to a DAG (Directed Acyclic Graph) representation for tag retrieval. This allows the system to correctly identify and present tags that may have multiple semantic parents (e.g., `Apple` as both a `Fruit` and a `Tech Brand`).

## 2. The Architectural Shift

### Previous State: Flat List of Tags
Previously, `contentRegionTags.tagScores()` returned a flat list of refined tags (e.g., `["Java"]`). The context of *how* we arrived at "Java" (via `SDE -> Coding`) was lost or implicit.

### New State: Tag Paths
We introduced a `TagPath` model. Now, for every suggested tag, we return the **full ancestral path** from the root.
*   **Result:** `taxonomyPaths` is a list of paths, e.g., `[[SDE, Coding, Java]]`.
*   **Poly-Hierarchy:** If "React" is a child of both "Library" and "Meta", we return *both* paths:
    1.  `Library -> React`
    2.  `Meta -> React`

## 3. Implementation Details

### Data Model Updates
*   **`TagPath` Record:** Created to hold a `List<TagScore>` representing the nodes in the path and a `finalScore`.
*   **`ContentRegionTags`:** Updated to include `List<TagPath> taxonomyPaths`. We kept `tagScores` for backward compatibility.

### Neo4j Recursive Query
We updated `Neo4jRepo` with a Cypher query to find all paths from a root node to a target tag:
```cypher
MATCH p=(root)-[:CHILD_OF*]->(leaf:Tag {name: $name}) 
WHERE NOT ()-[:CHILD_OF]->(root) 
RETURN nodes(p)
```
This efficiently offloads the path discovery to the graph database.

### Orchestrator Logic
The `TagOrchestratorService` now performs a two-step process:
1.  **Refinement (Recursive Deepening):** Drills down to find the most specific "winner" tags (e.g., picking `Java` over `Coding`).
2.  **Path Reconstruction:** For each "winner", it queries the Taxonomy Service to fetch all valid paths from the root, preserving the structural context.

## 4. Impact & Future
This change lays the groundwork for the "Smart Refinement" UI, where users will see the *reasoning* behind a tag suggestion (e.g., "We suggested 'Apple' because it's under 'Tech'"). It makes the system's logic explainable and robust against polysemy.
